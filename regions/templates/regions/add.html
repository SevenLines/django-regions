{% extends "base.html" %}
{% load bootstrap3 widget_tweaks %}
{% block content %}
    <form action="{% url "regions.views.add" %}" method="post" style="padding-top: 0.5en">
        {% csrf_token %}
        <div class="col-md-10">
            {{ form.name|add_class:'form-control' }}
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-default">Add</button>
        </div>

        <textarea hidden name="north_east" id="north_east" cols="30" rows="10">{{ form.top_left.value }}</textarea>
        <textarea hidden name="south_west" id="south_west" cols="30"
                  rows="10">{{ form.bottom_right.value }}</textarea>
        <textarea hidden name="polygon" id="polygon" cols="30" rows="10">{{ form.polygon.value }}</textarea>

    </form>
    <hr/>
    <div class="clearfix"></div>
    <div id="map-canvas" style="width: 100%; height: 400px;">
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script>

        function initialize() {
            var mapOptions = {
                zoom: 9,
                center: new google.maps.LatLng(-34.397, 150.644)
            };
            var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

            // init region
            var rectangle = new google.maps.Rectangle({
                editable: true,
                draggable: true,
                map: map
            });

            // listener for region bounds changing
            google.maps.event.addListener(rectangle, 'bounds_changed', function () {
                var bounds = rectangle.getBounds();
                var north_east = bounds.getNorthEast();
                var south_west = bounds.getSouthWest();

                // set POLYGON top left point
                var value = ['POINT (', north_east.lng(), ' ', north_east.lat(), ')'].join('');
                $("#north_east").html(value);

                // set POLYGON bottom right point
                value = ['POINT (', south_west.lng(), ' ', south_west.lat(), ')'].join('');
                $("#south_west").html(value);

                // generate POLYGON path
                value = ['POLYGON ((',
                    north_east.lng(), north_east.lat(), ',',
                    north_east.lng(), south_west.lat(), ',',
                    south_west.lng(), south_west.lat(), ',',
                    south_west.lng(), north_east.lat(), ',',
                    north_east.lng(), north_east.lat(),
                    '))'].join(' ');
                $("#polygon").html(value);
            });

            // define init user position as and move map there
            navigator.geolocation.getCurrentPosition(function (position) {
                var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                map.setCenter(latlng);

                var bounds = new google.maps.LatLngBounds(
                        new google.maps.LatLng(position.coords.latitude - 0.1, position.coords.longitude - 0.1),
                        new google.maps.LatLng(position.coords.latitude + 0.1, position.coords.longitude + 0.1)
                );

                rectangle.setBounds(bounds);
            });

        }

        google.maps.event.addDomListener(window, 'load', initialize);

    </script>
{% endblock %}